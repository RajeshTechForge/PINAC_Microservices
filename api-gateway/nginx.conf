events {
    worker_connections 1024;
}

http {
    upstream auth_service {
        server AUTH_SERVICE_URL;
    }

    upstream ai_response_service {
        server pinac-nexus.pinacai.workers.dev:443;
    }

    upstream web_search_service {
        server pinac-oracle.pinacai.workers.dev:443;
    }

    server {
        listen 8080;
        
        # Internal auth endpoint
        location = /auth {
            internal;
            proxy_pass AUTH_SERVICE_URL;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header Authorization $http_authorization;
        }
        
        # Health check endpoint (no auth required)
        location /health {
            return 200 "API Gateway is running\n";
            add_header Content-Type text/plain;
        }
        
        # Route to AI response service (protected)
        location /api/ai {
            auth_request /auth;
            auth_request_set $user_id $upstream_http_x_user_id;
            auth_request_set $user_email $upstream_http_x_user_email;
            auth_request_set $user_verified $upstream_http_x_user_verified;
            
            proxy_pass https://ai_response_service;
            proxy_ssl_server_name on;
            proxy_ssl_name pinac-nexus.pinacai.workers.dev;
            proxy_set_header Host pinac-nexus.pinacai.workers.dev;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-User-ID $user_id;
            proxy_set_header X-User-Email $user_email;
            proxy_set_header X-User-Verified $user_verified;
        }

        # Route to web search service (protected)
        location /api/search {
            auth_request /auth;
            auth_request_set $user_id $upstream_http_x_user_id;
            auth_request_set $user_email $upstream_http_x_user_email;
            auth_request_set $user_verified $upstream_http_x_user_verified;
            
            proxy_pass https://web_search_service;
            proxy_ssl_server_name on;
            proxy_ssl_name pinac-oracle.pinacai.workers.dev;
            proxy_set_header Host pinac-oracle.pinacai.workers.dev;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-User-ID $user_id;
            proxy_set_header X-User-Email $user_email;
            proxy_set_header X-User-Verified $user_verified;
        }
        
        # Default route
        location / {
            return 404 "Endpoint not found\n";
            add_header Content-Type text/plain;
        }
    }
}