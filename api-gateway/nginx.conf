events {
    worker_connections 1024;
}

http {
    upstream auth_service {
        server AUTH_SERVICE_URL;
    }

    upstream pinac_cloud_ai_service {
        server pinac-nexus.pinacai.workers.dev:443;
    }

    upstream web_search_service {
        server pinac-oracle.pinacai.workers.dev:443;
    }

    server {
        listen 8080;
        
        # Internal auth endpoint
        location = /auth {
            internal;
            proxy_pass https://AUTH_SERVICE_URL;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header Authorization $http_authorization;
            proxy_intercept_errors on;
        }
        
        # Custom error page for auth failures
        location = /auth_error {
            internal;
            add_header Content-Type application/json always;
            return 200 '{"error": "AUTHENTICATION_FAILED", "message": "Authentication required or failed", "timestamp": "$time_iso8601"}';
        }
        
        # Health check endpoint (no auth required)
        location /health {
            return 200 "API Gateway is running\n";
            add_header Content-Type text/plain;
        }
        
        # Route to AI response service (protected) - Only allow POST
        location /api/ai {
            # Reject non-POST requests at gateway level
            if ($request_method != POST) {
                add_header Content-Type application/json always;
                add_header Access-Control-Allow-Origin * always;
                return 405 '{"error": "METHOD_NOT_ALLOWED", "message": "Only POST method is allowed.", "timestamp": "$time_iso8601"}';
            }
            
            auth_request /auth;
            auth_request_set $auth_error $upstream_http_x_auth_error;
            auth_request_set $auth_message $upstream_http_x_auth_message;
            
            # Handle auth errors with specific error information
            error_page 401 = @auth_error_handler;
            error_page 403 = @auth_error_handler;
            
            proxy_pass https://pinac_cloud_ai_service;
            proxy_ssl_server_name on;
            proxy_ssl_name pinac-nexus.pinacai.workers.dev;
            proxy_set_header Host pinac-nexus.pinacai.workers.dev;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route to web search service (protected) - Only allow POST
        location /api/search {
            # Reject non-POST requests at gateway level
            if ($request_method != POST) {
                add_header Content-Type application/json always;
                add_header Access-Control-Allow-Origin * always;
                return 405 '{"error": "METHOD_NOT_ALLOWED", "message": "Only POST method is allowed.", "timestamp": "$time_iso8601"}';
            }

            auth_request /auth;
            auth_request_set $auth_error $upstream_http_x_auth_error;
            auth_request_set $auth_message $upstream_http_x_auth_message;
            
            # Handle auth errors with specific error information
            error_page 401 = @auth_error_handler;
            error_page 403 = @auth_error_handler;
            
            proxy_pass https://web_search_service;
            proxy_ssl_server_name on;
            proxy_ssl_name pinac-oracle.pinacai.workers.dev;
            proxy_set_header Host pinac-oracle.pinacai.workers.dev;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Auth error handler
        location @auth_error_handler {
            add_header Content-Type application/json always;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

            return 401 '{"error": "$auth_error", "message": "$auth_message", "timestamp": "$time_iso8601"}';
        }
        
        # Default route
        location / {
            return 404 "Endpoint not found\n";
            add_header Content-Type text/plain;
        }
    }
}